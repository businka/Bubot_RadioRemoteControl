Алгоритм

Получили сообщение.
Проверили соответствуют ли текущие параметры порта, требуемым. Если нет изменили.
Выполнили команду.
Получили результат.
Ответили на сообщение.